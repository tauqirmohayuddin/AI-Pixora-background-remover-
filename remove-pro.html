<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Pixora Pro — Debug</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;background:#f6f7fb;color:#222;padding:18px}
    .card{background:#fff;padding:18px;border-radius:10px;max-width:760px;margin:18px auto;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    button{padding:10px 14px;border-radius:8px;border:0;background:#e63a46;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:0.95rem}
    pre{background:#f3f4f6;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    input[type=file]{margin-top:8px}
    .danger{color:#b00020}
  </style>
</head>
<body>
  <div class="card">
    <h2>AI Pixora Pro — Debug helper</h2>
    <p class="muted">This page will show the raw responses from your Netlify function so we can see exactly what's failing.</p>

    <div style="margin:12px 0">
      <button id="testBtn">Connectivity test (empty POST)</button>
      <span style="margin-left:12px" class="muted">— sends an empty POST to <code>/.netlify/functions/remove-bg</code></span>
    </div>

    <div style="margin:12px 0">
      <label class="muted">Choose image for real test (remove.bg expects form field name <code>image_file</code>):</label><br>
      <input id="fileInput" type="file" accept="image/*" />
      <div style="margin-top:8px">
        <button id="sendBtn">Send file</button>
      </div>
    </div>

    <h3>Result</h3>
    <div id="result" aria-live="polite">
      <pre id="out">(no test run yet)</pre>
    </div>

    <h3>Quick instructions</h3>
    <ol>
      <li>Deploy after committing this file.</li>
      <li>Open page and click <strong>Connectivity test</strong>.</li>
      <li>Then test with a small image by clicking <strong>Send file</strong>.</li>
      <li>Copy & paste the output here (or screenshot it).</li>
    </ol>
  </div>

<script>
(function(){
  const NETLIFY_URL = "/.netlify/functions/remove-bg";
  const out = document.getElementById('out');
  const testBtn = document.getElementById('testBtn');
  const sendBtn = document.getElementById('sendBtn');
  const fileInput = document.getElementById('fileInput');

  function show(text){
    out.textContent = text;
    console.log(text);
  }

  async function fetchText(req){
    try {
      const res = await fetch(req);
      const headers = {};
      res.headers.forEach((v,k)=> headers[k]=v);
      // Try to read body as text; if binary returned this will be gibberish but we still capture status
      const body = await res.text();
      return { status: res.status, ok: res.ok, statusText: res.statusText, headers, body };
    } catch(e){
      return { error: String(e) };
    }
  }

  testBtn.addEventListener('click', async ()=>{
    show('Running connectivity test...\n\nPOST ' + NETLIFY_URL + '\n\n(please wait)');
    const r = await fetchText(new Request(NETLIFY_URL, { method: 'POST', body: new FormData() }));
    if (r.error) {
      show('Network error:\n' + r.error);
      return;
    }
    show('Status: ' + r.status + ' ' + r.statusText + '\n\nHeaders:\n' + JSON.stringify(r.headers, null, 2) + '\n\nBody (first 4000 chars):\n' + (r.body ? r.body.slice(0,4000) : '(empty)'));
  });

  sendBtn.addEventListener('click', async ()=>{
    if (!fileInput.files || !fileInput.files.length) {
      show('Please choose a file first.');
      return;
    }
    const file = fileInput.files[0];
    show('Uploading file "' + file.name + '" (' + file.size + ' bytes) ...');

    const fd = new FormData();
    fd.append('image_file', file);
    fd.append('size', 'auto');

    try {
      const res = await fetch(NETLIFY_URL, { method: 'POST', body: fd });
      const headers = {};
      res.headers.forEach((v,k)=> headers[k]=v);

      // If binary result, try to download to blob and show blob size; also try text fallback
      let bodySnippet = '';
      try {
        // attempt to read as text (error message likely)
        const maybeText = await res.text();
        bodySnippet = maybeText;
      } catch(e){
        bodySnippet = '(could not read body as text: ' + e + ')';
      }

      // If response is binary (image) the server may return binary and text will be empty or garbage.
      // Provide details for debugging:
      show('Status: ' + res.status + ' ' + res.statusText + '\n\nHeaders:\n' + JSON.stringify(headers, null, 2) +
           '\n\nBody (first 4000 chars):\n' + (bodySnippet ? bodySnippet.slice(0,4000) : '(empty)') +
           '\n\nNote: if the function returns an image binary the body may look empty here. In that case check function logs in Netlify.');
    } catch(err){
      show('Network/Client error:\n' + String(err));
    }
  });

  // Also expose window.testFunc for console use
  window.testFunc = async function(){
    testBtn.click();
  };
})();
</script><!-- Debug helper: allows console to test connectivity -->
<script>
  // Expose a test function to the page as window.testFunc
  window.testFunc = async function() {
    try {
      console.log('Running testFunc: hitting /.netlify/functions/remove-bg');
      const res = await fetch('/.netlify/functions/remove-bg', { method: 'POST', body: new FormData() });
      const text = await res.text().catch(()=>'<non-text response>');
      console.log('testFunc result:', res.status, res.statusText);
      console.log('Body (first 2000 chars):', (text || '').slice(0,2000));
      alert('testFunc finished — check console for results.');
    } catch (e) {
      console.error('testFunc error:', e);
      alert('testFunc error — see console.');
    }
  };
  // small note so the console can log typeof immediately if you run it
  console.log('Debug helper: window.testFunc installed.');
</script><!-- Debug helper: exposes window.testFunc for console connectivity checks -->
<script>
  // safe debug helper — only logs connectivity and response body snippet
  window.testFunc = async function () {
    const url = '/.netlify/functions/remove-bg'; // function path used by the page
    console.log('Running connectivity test to:', url);
    try {
      const res = await fetch(url, { method: 'POST' });
      console.log('Fetch returned:', res.status, res.statusText);
      // try read body as text (if binary this will fail)
      let bodySnippet = '';
      try {
        const text = await res.text();
        bodySnippet = text.slice(0, 4000);
      } catch (e) {
        bodySnippet = '(could not read body as text — probably binary)';
      }
      console.log('Body (first 4000 chars):\n', bodySnippet);
      return { status: res.status, statusText: res.statusText, bodySnippet };
    } catch (err) {
      console.error('Network/Client error:', err);
      return { error: String(err) };
    }
  };
</script><script>
window.testFunc = async function () {
  console.log("✅ testFunc loaded successfully");

  const testBtn =
    document.getElementById("testBtn") ||
    document.getElementById("sendBtn") ||
    document.querySelector("button");

  if (testBtn) {
    console.log("Found button:", testBtn.id);
    testBtn.click();
  } else {
    console.error("❌ No test button found.");
  }
};
console.log("✅ Script initialized");
</script>
</body>
</html>
</body>
</html>
