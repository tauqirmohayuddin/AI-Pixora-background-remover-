<script>
async function fileToBase64(file){
  return await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = () => {
      // reader.result like "data:image/png;base64,AAAA..."
      const parts = reader.result.split(',');
      resolve(parts[1]); // return only base64 string
    };
    reader.readAsDataURL(file);
  });
}

async function removeBackground() {
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) {
    alert('Choose an image first');
    return;
  }
  const file = fileInput.files[0];
  try {
    // convert to base64 (no data:* prefix)
    const imageBase64 = await fileToBase64(file);

    // call netlify function
    const resp = await fetch('/.netlify/functions/remove-bg', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imageBase64 })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      console.error('Function returned error:', resp.status, txt);
      alert('Error from server: ' + txt);
      return;
    }

    const data = await resp.json();
    if (!data.resultBase64) {
      console.error('No resultBase64 in response', data);
      alert('No image returned');
      return;
    }

    // convert base64 result to blob and show download link
    const blob = await (await fetch('data:image/png;base64,' + data.resultBase64)).blob();
    const url = URL.createObjectURL(blob);

    // show image in an <img id="outImage"> or create a download button
    const out = document.getElementById('outImage');
    if (out) {
      out.src = url;
    } else {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'result.png';
      a.textContent = 'Download result';
      document.body.appendChild(a);
    }

  } catch (err) {
    console.error('Client error', err);
    alert('Client error: ' + String(err));
  }
}

document.getElementById('removeBtn').addEventListener('click', removeBackground);
</script>
