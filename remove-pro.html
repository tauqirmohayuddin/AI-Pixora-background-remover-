<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Pixora Pro - Debug</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;padding:30px;background:#f6f9fb}
    .card{background:#fff;padding:18px;border-radius:10px;max-width:720px;margin:20px auto}
    button{padding:10px 14px;border-radius:8px;border:0;background:#b9413f;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:0.95rem}
    #result{margin-top:12px;white-space:pre-wrap;font-family:monospace;background:#f3f4f6;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>AI Pixora Pro – Debug helper</h2>
    <p class="muted">This page includes a window.testFunc you can run from the Console.</p>

    <div style="margin:12px 0">
      <button id="testBtn">Connectivity test (empty POST)</button>
      <span style="margin-left:12px" class="muted">→ sends a check to the server</span>
    </div>

    <div style="margin:12px 0">
      <label class="muted">Choose image for real test (remove background)</label><br/>
      <input id="fileInput" type="file" accept="image/*" />
      <div style="margin-top:8px">
        <button id="sendBtn">Send file</button>
      </div>
    </div>

    <h3>Result</h3>
    <div id="result" aria-live="polite">No tests run yet.</div>
  </div>

<script>
(() => {
  const NETLIFY_URL = "/.netlify/functions/remove-bg"; // update if your function is at a different path
  const out = document.getElementById('result');
  const testBtn = document.getElementById('testBtn');
  const sendBtn = document.getElementById('sendBtn');
  const fileInput = document.getElementById('fileInput');

  function show(text){
    out.textContent = text;
    console.log(text);
  }

  async function fetchText(req){
    try{
      const res = await fetch(req);
      const headers = {};
      res.headers.forEach((v,k)=> headers[k]=v);
      let body='';
      try { body = await res.text(); } catch(e){ body='(could not read body as text)'; }
      console.log('Fetch returned:', res.status, res.statusText);
      console.log('Headers:', headers);
      console.log('Body (first 4000 chars):', body.slice(0,4000));
      return { status: res.status, statusText: res.statusText, ok: res.ok, bodySnippet: body.slice(0,4000) };
    } catch(e){
      console.error('Network/Client error:', e);
      return { error: String(e) };
    }
  }

  testBtn.addEventListener('click', async ()=>{
    show('Running connectivity test...\\nPOST ' + NETLIFY_URL);
    const r = await fetchText(new Request(NETLIFY_URL, { method: 'POST' }));
    if (r.error) { show('Network error:\\n' + r.error); return; }
    show('Status: ' + r.status + ' ' + (r.statusText || '') + '\\n\\nBody (first 4000 chars):\\n' + (r.bodySnippet||''));
  });

  sendBtn.addEventListener('click', async () => {
    if (!fileInput.files || !fileInput.files.length) { show('Please choose a file first.'); return; }
    const file = fileInput.files[0];
    show('Uploading file "' + file.name + '" (' + file.size + ' bytes)...');
    const fd = new FormData();
    fd.append('image_file', file);
    fd.append('size','auto');
    try {
      const res = await fetch(NETLIFY_URL, { method: 'POST', body: fd });
      let bodySnippet = '';
      try { bodySnippet = await res.text(); } catch(e){ bodySnippet='(could not read body as text)'; }
      show('Status: ' + res.status + ' ' + res.statusText + '\\n\\nBody (first 4000 chars):\\n' + bodySnippet.slice(0,4000));
    } catch(err){
      show('Network/Client error:\\n' + String(err));
    }
  });

  // Expose for Console use:
  window.testFunc = async function(){
    // Run the same connectivity check but callable from Console
    show('Running window.testFunc connectivity test...');
    const r = await fetchText(new Request(NETLIFY_URL, { method: 'POST' }));
    if (r.error) { show('Network error:\\n' + r.error); return r; }
    show('Status: ' + r.status + ' ' + (r.statusText || '') + '\\n\\nBody (first 4000 chars):\\n' + (r.bodySnippet||''));
    return r;
  };

  // small self-check log so you can see script loaded
  console.log('debug script loaded; window.testFunc available');
})();
</script>
</body>
</html>
