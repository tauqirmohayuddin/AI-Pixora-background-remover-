<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Pixora Pro — Remove Background</title>
<style>
  :root { --accent:#d62828; --radius:12px; }
  body{font-family:system-ui,Arial,sans-serif;background:#f5f7fa;margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{background:#fff;padding:28px;border-radius:14px;box-shadow:0 8px 30px rgba(9,30,66,.08);max-width:760px;width:94%}
  h1{margin:0 0 8px;font-size:1.6rem;color:#8b1f1f;text-align:center}
  p.muted{color:#666;margin-top:6px;text-align:center}
  .controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-top:18px;flex-wrap:wrap}
  input[type=file]{padding:6px}
  button{background:var(--accent);color:#fff;border:0;padding:10px 18px;border-radius:12px;cursor:pointer}
  #loader{border:4px solid #eee;border-top:4px solid var(--accent);width:40px;height:40px;border-radius:50%;animation:spin 1s linear infinite;display:none;margin:10px auto}
  @keyframes spin{to{transform:rotate(360deg)}}
  #status{white-space:pre-wrap;margin-top:12px;color:#222;font-family:monospace;font-size:.95rem;min-height:48px}
  #resultImg{display:block;margin:18px auto;max-width:100%;border-radius:8px}
  .download{display:inline-block;margin-top:8px}
  .muted{color:#666}
</style>
</head>
<body>
  <div class="card">
    <h1>AI Pixora Pro</h1>
    <p class="muted">Upload a photo and let AI Pixora remove the background. (Debug / test page)</p>

    <div style="text-align:center;margin-top:18px">
      <input id="fileInput" type="file" accept="image/*" />
    </div>

    <div class="controls" style="justify-content:center">
      <button id="removeBtn">Remove Background</button>
      <button id="testBtn" style="background:#0077cc">Connectivity test</button>
    </div>

    <div id="loader" aria-hidden="true"></div>

    <div id="status" aria-live="polite" class="muted">Status: idle</div>

    <img id="resultImg" alt="Result image" style="display:none"/>
    <div style="text-align:center">
      <a id="download" class="download" download="AI-Pixora-Result.png" style="display:none">Download result</a>
    </div>
  </div>

<script>
(() => {
  // EDIT THIS if your server function URL differs
  const NETLIFY_URL = '/.netlify/functions/remove-bg';

  const out = document.getElementById('status');
  const loader = document.getElementById('loader');
  const testBtn = document.getElementById('testBtn');
  const removeBtn = document.getElementById('removeBtn');
  const fileInput = document.getElementById('fileInput');
  const resultImg = document.getElementById('resultImg');
  const downloadLink = document.getElementById('download');

  function show(msg){ out.textContent = msg; console.log(msg); }

  // The real function you will call from Console: window.testFunc()
  window.testFunc = async function() {
    // quick test: attempt an empty POST to NETLIFY_URL to ensure function reachable
    show('Running connectivity test (empty POST) → ' + NETLIFY_URL);
    try {
      const r = await fetch(NETLIFY_URL, { method: 'POST' });
      const text = await r.text().catch(()=>'<non-text response>');
      show('Connectivity test returned: ' + r.status + ' ' + r.statusText + '\n\nBody (first 1200 chars):\n' + (String(text).slice(0,1200)));
      console.log('headers:', Array.from(r.headers.entries()));
      return { status: r.status, text: String(text).slice(0,1200) };
    } catch (err) {
      console.error('Connectivity error', err);
      show('Network/Client error:\n' + String(err));
      return { error: String(err) };
    }
  };

  // Helper: send selected file
  async function sendFile(file) {
    if (!file) { show('Please select a file first.'); return; }
    loader.style.display = 'block';
    resultImg.style.display = 'none';
    downloadLink.style.display = 'none';
    show('Uploading file "' + file.name + '" (' + file.size + ' bytes) ...');

    const fd = new FormData();
    fd.append('image_file', file);
    fd.append('size', 'auto');

    try {
      const res = await fetch(NETLIFY_URL, { method: 'POST', body: fd });
      show('Fetch returned: ' + res.status + ' ' + res.statusText);

      // Try read as text (useful if the server returned an error HTML)
      let bodySnippet = '';
      try {
        const txt = await res.text();
        bodySnippet = txt.slice(0, 4000);
      } catch(e){
        bodySnippet = '(could not read body as text — probably binary image)';
      }

      if (!res.ok) {
        show('✖ Server error: ' + res.status + ' - ' + res.statusText + '\n\nBody (first 2000 chars):\n' + bodySnippet);
        return;
      }

      // If OK, assume binary image in response -> convert to blob and display
      const blob = await res.blob();
      console.log('Received blob size:', blob.size, 'type:', blob.type);
      const url = URL.createObjectURL(blob);
      resultImg.src = url;
      resultImg.style.display = 'block';
      downloadLink.href = url;
      downloadLink.style.display = 'inline-block';
      show('✓ Background removed — result displayed below. You can download it.');
    } catch (err) {
      console.error('Client error:', err);
      show('Network/Client error:\n' + String(err));
    } finally {
      loader.style.display = 'none';
    }
  }

  // Wire up UI
  removeBtn.addEventListener('click', async () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) { show('Please choose an image file first.'); return; }
    await sendFile(f);
  });

  testBtn.addEventListener('click', async () => {
    // delegate to window.testFunc
    show('Starting connectivity test using window.testFunc() ...');
    await window.testFunc();
  });

  // Console helper: also expose a short alias
  window.pxTest = window.testFunc;

  console.log('Debug page script loaded. NETLIFY_URL =', NETLIFY_URL);
})();
</script>
</body>
</html>
