<script>
  // Use a relative function path (safer / simpler on Netlify)
  const NETLIFY_URL = "/.netlify/functions/remove-bg";

  const removeBtn = document.getElementById("remove-btn");
  const fileInput = document.getElementById("file-input");
  const loader = document.getElementById("loader");
  const statusDiv = document.getElementById("status");
  const resultImg = document.getElementById("result-img");
  const downloadBtn = document.getElementById("download");

  // Utility: show message AND console.log
  function show(msg) {
    console.log(msg);
    statusDiv.textContent = msg;
  }

  removeBtn.onclick = async () => {
    if (!fileInput.files || !fileInput.files.length) {
      show("Please select an image first.");
      return;
    }

    const file = fileInput.files[0];

    // UI start
    show("Uploading and processing...");
    loader.style.display = "block";
    resultImg.style.display = "none";
    downloadBtn.style.display = "none";
    removeBtn.disabled = true;

    try {
      const fd = new FormData();
      fd.append("image_file", file); // remove.bg expects "image_file"
      fd.append("size", "auto");

      console.log("Sending POST to:", NETLIFY_URL, "FormData keys:", Array.from(fd.keys()));

      // send the form
      const res = await fetch(NETLIFY_URL, {
        method: "POST",
        body: fd,
        // Don't set Content-Type: the browser will set it (with boundary)
      });

      console.log("Fetch returned:", res.status, res.statusText);

      if (!res.ok) {
        // try to read text body from the function (useful for debugging)
        const text = await res.text();
        console.error("Server error text:", text);
        show("❌ Server error: " + res.status + " — see console for details.");
        // put server message in status for mobile visibility
        statusDiv.innerText = "❌ Server: " + res.status + " — " + (text || res.statusText);
        return;
      }

      // success: function should return base64 image (isBase64Encoded:true),
      // but Netlify will respond with binary if we forward correctly. We'll accept blob.
      const blob = await res.blob();
      console.log("Received blob, size:", blob.size);
      const url = URL.createObjectURL(blob);
      resultImg.src = url;
      resultImg.style.display = "block";
      downloadBtn.href = url;
      downloadBtn.style.display = "inline-block";
      show("✅ Background removed successfully!");
    } catch (err) {
      console.error("Client error:", err);
      show("⚠️ Network/Client error: " + (err.message || err));
    } finally {
      loader.style.display = "none";
      removeBtn.disabled = false;
    }
  };

  // --- Quick connectivity test (open browser console and run `testFunc()`):
  window.testFunc = async function() {
    try {
      console.log("Connectivity test to", NETLIFY_URL);
      const r = await fetch(NETLIFY_URL, { method: "POST", body: new FormData() });
      console.log("Connectivity test status:", r.status, r.statusText);
      const t = await r.text();
      console.log("Response body (first 1000 chars):", t.slice(0,1000));
      alert("Connectivity test finished. Check console for details.");
    } catch (e) {
      console.error("Connectivity test error:", e);
      alert("Connectivity test error — see console.");
    }
  };
</script>
